<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Plant & Seed Donation System (Dashboard)</title>
<style>
  :root{
    --primary:#2d6a4f;
    --secondary:#eafaf1;
    --text:#222;
    --card-bg:#fff;
    --muted:#6c757d;
  }
  *{box-sizing:border-box;margin:0;padding:0;font-family:Inter,system-ui,Arial,sans-serif}
  body{min-height:100vh;display:flex;background:var(--secondary);color:var(--text)}
  .sidebar{width:260px;background:#fff;border-right:1px solid #e6e6e6;position:fixed;top:0;bottom:0;left:0;padding:18px;display:flex;flex-direction:column;gap:8px;z-index:5;overflow:auto}
  .profile-row{display:flex;flex-direction:column;align-items:center;text-align:center;margin-bottom:10px}
  .profile-row img{width:100px;height:100px;border-radius:50%;border:3px solid var(--primary);object-fit:cover;margin-bottom:8px}
  .profile-name{font-weight:700;color:var(--primary)}
  .sidebar a,.sidebar button{display:block;text-align:left;padding:10px;border-radius:8px;border:none;background:none;color:var(--text);cursor:pointer;font-size:15px}
  .sidebar a:hover,.sidebar button:hover{background:#eef8ef;color:var(--primary)}
  .logout-btn{width:100%;background:var(--primary);color:#fff;border:none;padding:10px;border-radius:8px;margin-top:auto;cursor:pointer}
  .content{margin-left:280px;padding:22px;flex:1;display:block;min-height:100vh}
  .header-row{display:flex;justify-content:space-between;align-items:center;gap:12px}
  .search-input{padding:10px;border-radius:8px;border:1px solid #ccc;width:320px}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:18px;margin-top:18px}
  .card{background:var(--card-bg);padding:12px;border-radius:12px;box-shadow:0 4px 14px rgba(0,0,0,.06);text-align:center;cursor:pointer;position:relative}
  .card img{width:100%;height:150px;object-fit:cover;border-radius:8px;margin-bottom:10px}
  .small-btn{padding:8px 10px;border-radius:8px;border:none;background:var(--primary);color:#fff;cursor:pointer;margin-top:6px;margin-right:4px}
  .small-btn.ghost{background:transparent;color:var(--primary);border:1px solid var(--primary)}
  .form-section{max-width:900px;background:var(--card-bg);padding:18px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,.06);margin-top:18px}
  .form-row{display:flex;gap:12px}
  .form-row input, .form-row textarea{flex:1;padding:10px;border-radius:8px;border:1px solid #ccc;width:100%;}
  .hidden{display:none}
  .center{text-align:center;margin-top:10px}
  .section-title{color:var(--primary);font-size:20px;margin-bottom:12px}
  #plantPopup{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.5);z-index:30}
  .popupContent{background:#fff;padding:18px;border-radius:10px;max-width:420px;width:92%;box-shadow:0 8px 30px rgba(0,0,0,.25);text-align:left}
  .popupContent img{width:100%;height:180px;object-fit:cover;border-radius:8px;margin-bottom:10px}
  .popup-row{display:flex;gap:8px;justify-content:flex-end;margin-top:8px}
  .donor-list{display:grid;gap:12px;margin-top:12px}
  .donor-card{background:#fff;padding:12px;border-radius:10px;display:flex;align-items:center;gap:12px;box-shadow:0 2px 8px rgba(0,0,0,.06)}
  .donor-card img{width:60px;height:60px;border-radius:50%;object-fit:cover}
  .gallery-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-top:12px}
  .gallery-grid img{width:100%;height:140px;object-fit:cover;border-radius:8px}
  .profile-edit{display:grid;grid-template-columns:120px 1fr;gap:12px;align-items:start}
  .profile-edit .profile-actions{display:flex;gap:8px;justify-content:center;margin-top:8px}
  #profilePicInput{margin-top:8px;}
  .request-card{padding:10px;border-radius:8px;border:1px solid #eee;margin-bottom:10px;background:#fafafa}
  .comment-box{background:#f8fff9;padding:10px;border-radius:8px;margin-bottom:10px;border:1px solid #d8f3dc;}
  .comment-author{font-weight:600;color:var(--primary);}
  label{display:block;margin-top:8px;font-size:13px;color:var(--muted)}
  input[type="text"], input[type="email"], textarea {font-size:14px}
  @media(max-width:900px){
    .content{margin-left:0;padding:14px}
    .sidebar{position:relative;width:100%;display:flex}
    .header-row{flex-direction:column;align-items:stretch;}
    .search-input{width:100%;}
  }
  .muted { color: var(--muted); font-size:12px; }
</style>
</head>
<body>

<nav class="sidebar" id="sidebar">
  <div class="profile-row">
    <img id="profilePic" src="https://cdn-icons-png.flaticon.com/512/149/149071.png" alt="Profile">
    <div class="profile-name" id="profileLabel">Profile</div>
    <div class="muted" id="profileEmail">--</div>
  </div>

  <a onclick="showSection('home')">üè† Home</a>
  <a onclick="showSection('donate')">üå± Donate Plant</a>
  <a onclick="showSection('donateSeeds')">üåø Donate Seeds</a>
  <a onclick="showSection('requests')">üì¨ Requests</a>
  <a onclick="showSection('care')">üí¨ Plant Care</a>
  <a onclick="showSection('myRequests')">üìù My Requests</a>
  <a onclick="showSection('profile')">üë§ Profile</a>
  <button class="logout-btn" onclick="logout()">Logout</button>
</nav>

<main class="content" id="content">
  <!-- HOME -->
  <section id="homeSection">
    <div class="header-row">
      <h2>Available Plants & Seeds</h2>
      <input id="searchInput" class="search-input" placeholder="Search plants/seeds..." oninput="renderHome()" />
    </div>
    <div id="homeGrid" class="grid"></div>
  </section>

  <!-- DONATE PLANT (location hidden; auto-uses profile address) -->
  <section id="donateSection" class="hidden">
    <div class="form-section">
      <div class="section-title">üå± Donate a Plant</div>
      <div class="form-row" style="flex-direction:column">
        <input id="plantName" placeholder="Plant name" />
        <!-- hidden location auto-filled from profile -->
        <input id="plantLocation" type="hidden" />
        <input id="plantImage" type="file" accept="image/*" />
        <textarea id="plantDescription" rows="4" placeholder="Description"></textarea>
        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
          <button class="small-btn ghost" onclick="showSection('home')">Cancel</button>
          <button class="small-btn" onclick="addPlant()">Donate Plant</button>
        </div>
      </div>
    </div>
  </section>

  <!-- DONATE SEEDS (location hidden; auto-uses profile address) -->
  <section id="donateSeedsSection" class="hidden">
    <div class="form-section">
      <div class="section-title">üåø Donate Seeds</div>
      <div class="form-row" style="flex-direction:column">
        <input id="seedName" placeholder="Seed name" />
        <input id="seedQuantity" placeholder="Quantity (e.g., 50 packs)" />
        <!-- hidden location auto-filled from profile -->
        <input id="seedLocation" type="hidden" />
        <input id="seedImage" type="file" accept="image/*" />
        <textarea id="seedDescription" rows="4" placeholder="Description"></textarea>
        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
          <button class="small-btn ghost" onclick="showSection('home')">Cancel</button>
          <button class="small-btn" onclick="addSeed()">Donate Seeds</button>
        </div>
      </div>
    </div>
  </section>

  <!-- REQUESTS (donor view) -->
  <section id="requestsSection" class="hidden">
    <h2>Requests Received</h2>
    <div id="requestsList" class="donor-list"></div>
  </section>

  <!-- PROFILE (detailed address fields) -->
  <section id="profileSection" class="hidden">
    <h2>Profile</h2>
    <div class="form-section">
      <div class="profile-edit">
        <img id="profileEditPic" src="https://cdn-icons-png.flaticon.com/512/149/149071.png" style="width:100px;height:100px;border-radius:50%;object-fit:cover">
        <div>
          <label>Full Name</label>
          <input id="profileNameInput" placeholder="Your Name" />
          <label>Email</label>
          <input id="profileEmailInput" placeholder="Email" />
          <label>Door No / Flat No</label>
          <input id="profileDoorInput" placeholder="Door No / Flat No" />
          <label>Street / Area</label>
          <input id="profileStreetInput" placeholder="Street / Area" />
          <label>City</label>
          <input id="profileCityInput" placeholder="City" />
          <label>State</label>
          <input id="profileStateInput" placeholder="State" />
          <label>Pincode</label>
          <input id="profilePincodeInput" placeholder="Pincode" />
          <label>Phone Number</label>
          <input id="profilePhoneInput" placeholder="Phone number" />
          <label>Profile Picture</label>
          <input type="file" id="profilePicInput" accept="image/*">
          <div class="profile-actions">
            <button class="small-btn" onclick="saveProfile()">Save Profile</button>
          </div>
        </div>
      </div>
    </div>

    <h3 style="margin-top:20px;">ü™¥ My Donations</h3>
    <div id="myDonations" class="grid"></div>
  </section>

  <!-- PLANT CARE -->
  <section id="careSection" class="hidden">
    <h2>üí¨ Plant Care Tips</h2>
    <div class="form-section" style="display:flex;flex-direction:column;gap:10px;">
      <div id="careTips" style="max-height:400px;overflow-y:auto;padding:10px;border:1px solid #ccc;border-radius:8px;background:#fafafa;"></div>
      <div style="display:flex;gap:8px;">
        <input id="tipInput" type="text" placeholder="Share a tip..." style="flex:1;padding:10px;border-radius:8px;border:1px solid #ccc;" />
        <button class="small-btn" onclick="addTip()">Send</button>
      </div>
    </div>
  </section>

  <!-- MY REQUESTS (ACCEPTED) (receiver view) -->
  <section id="myRequestsSection" class="hidden">
    <h2>üìù My Accepted Requests</h2>
    <div id="myRequestsList" class="donor-list"></div>
  </section>

  <!-- PLANT REQUEST POPUP -->
  <div id="plantPopup">
    <div class="popupContent">
      <h3 id="popupTitle"></h3>
      <img id="popupImg" src="" />
      <p id="popupDesc"></p>
      <input id="popupMsg" placeholder="Message to donor" />
      <div class="popup-row">
        <button class="small-btn ghost" onclick="closePopup()">Cancel</button>
        <button class="small-btn" onclick="sendRequest()">Send Request</button>
      </div>
    </div>
  </div>

</main>

<script>
/* ----- Data load ----- */
let plants = JSON.parse(localStorage.getItem("plants")) || [];
let seeds = JSON.parse(localStorage.getItem("seeds")) || [];
let requests = JSON.parse(localStorage.getItem("requests")) || [];
let tips = JSON.parse(localStorage.getItem("tips")) || [];
let currentUser = JSON.parse(localStorage.getItem("currentUser"));

/* Redirect to login if not present */
if(!currentUser){
  alert("Please login first!");
  window.location.href = "login.html";
}

/* Populate profile labels and inputs */
document.getElementById('profileLabel').innerText = currentUser.name || "Profile";
document.getElementById('profileEmail').innerText = currentUser.email || "--";
document.getElementById('profileNameInput').value = currentUser.name || "";
document.getElementById('profileEmailInput').value = currentUser.email || "";
document.getElementById('profileDoorInput').value = currentUser.door || "";
document.getElementById('profileStreetInput').value = currentUser.street || "";
document.getElementById('profileCityInput').value = currentUser.city || "";
document.getElementById('profileStateInput').value = currentUser.state || "";
document.getElementById('profilePincodeInput').value = currentUser.pincode || "";
document.getElementById('profilePhoneInput').value = currentUser.phone || "";
if(currentUser.profilePic){
  document.getElementById('profileEditPic').src = currentUser.profilePic;
  document.getElementById('profilePic').src = currentUser.profilePic;
}

/* Keep selected item when user opens popup */
let selectedItem = null;

/* ===== LOGOUT ===== */
function logout(){
  localStorage.removeItem("currentUser");
  window.location.href = "homepage.html";
}

/* ===== SHOW SECTION (auto-fill hidden donation locations) ===== */
function showSection(section){
  const sections = ['home','donate','donateSeeds','profile','requests','care','myRequests'];
  sections.forEach(sec => document.getElementById(sec+'Section').classList.add('hidden'));
  document.getElementById(section+'Section').classList.remove('hidden');

  if(section==='home') renderHome();
  if(section==='requests') renderRequests();
  if(section==='profile') renderMyDonations();
  if(section==='care') renderCareTips();
  if(section==='myRequests') renderMyRequests();

  // Auto-fill hidden donation location fields from profile (full combined address)
  const profileAddress = currentUser.location || buildAddressFromProfile(currentUser);
  if(section === 'donate'){
    document.getElementById('plantLocation').value = profileAddress || '';
  }
  if(section === 'donateSeeds'){
    document.getElementById('seedLocation').value = profileAddress || '';
  }
}

/* helper: build full address from profile inputs if needed */
function buildAddressFromProfile(user){
  if(!user) return '';
  const parts = [];
  if(user.door) parts.push(user.door);
  if(user.street) parts.push(user.street);
  if(user.city) parts.push(user.city);
  if(user.state) parts.push(user.state);
  let address = parts.join(', ');
  if(user.pincode) address = address + (address ? ' - ' + user.pincode : user.pincode);
  return address;
}

/* ===== ADD PLANT (auto-attach full profile address & phone) ===== */
function addPlant(){
  const name = document.getElementById('plantName').value.trim();
  const description = document.getElementById('plantDescription').value.trim();
  const fileInput = document.getElementById('plantImage');

  if(!name) return alert('Please enter plant name');

  const address = currentUser.location || buildAddressFromProfile(currentUser) || 'Address not provided';
  const phone = currentUser.phone || 'Phone not provided';
  const donorEmail = currentUser.email || '';

  const reader = new FileReader();
  reader.onload = function(e){
    const newPlant = {
      type: 'plant',
      name,
      desc: description,
      donor: currentUser.name,
      donorEmail: donorEmail,
      address: address,
      phone: phone,
      image: e.target.result,
      date: new Date().toISOString()
    };
    plants.push(newPlant);
    localStorage.setItem("plants", JSON.stringify(plants));
    // clear small fields
    document.getElementById('plantName').value = '';
    document.getElementById('plantDescription').value = '';
    document.getElementById('plantImage').value = '';
    alert('Plant donated successfully!');
    showSection('home');
  };
  if(fileInput.files && fileInput.files[0]) reader.readAsDataURL(fileInput.files[0]);
  else reader.onload({ target: { result: 'https://via.placeholder.com/200' } });
}

/* ===== ADD SEED (auto-attach full profile address & phone) ===== */
function addSeed(){
  const name = document.getElementById('seedName').value.trim();
  const qty = document.getElementById('seedQuantity').value.trim();
  const description = document.getElementById('seedDescription').value.trim();
  const fileInput = document.getElementById('seedImage');

  if(!name || !qty) return alert('Please enter seed name and quantity');

  const address = currentUser.location || buildAddressFromProfile(currentUser) || 'Address not provided';
  const phone = currentUser.phone || 'Phone not provided';
  const donorEmail = currentUser.email || '';

  const reader = new FileReader();
  reader.onload = function(e){
    const newSeed = {
      type: 'seed',
      name,
      qty,
      desc: description,
      donor: currentUser.name,
      donorEmail: donorEmail,
      address: address,
      phone: phone,
      image: e.target.result,
      date: new Date().toISOString()
    };
    seeds.push(newSeed);
    localStorage.setItem("seeds", JSON.stringify(seeds));
    document.getElementById('seedName').value = '';
    document.getElementById('seedQuantity').value = '';
    document.getElementById('seedDescription').value = '';
    document.getElementById('seedImage').value = '';
    alert('Seed donation added successfully!');
    showSection('home');
  };
  if(fileInput.files && fileInput.files[0]) reader.readAsDataURL(fileInput.files[0]);
  else reader.onload({ target: { result: 'https://via.placeholder.com/200' } });
}

/* ===== RENDER HOME ===== */
function renderHome(){
  const grid = document.getElementById('homeGrid');
  grid.innerHTML = '';
  const search = document.getElementById('searchInput').value.toLowerCase();
  [...plants,...seeds].filter(item => item.name.toLowerCase().includes(search)).forEach(item=>{
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `<img src="${item.image}" /><b>${item.name}</b><div class="muted">${item.type==='plant'?'Plant':'Seeds'}</div>`;
    card.onclick = () => openPopup(item);
    grid.appendChild(card);
  });
}

/* ===== POPUP ===== */
function openPopup(item){
  if(item.donor === currentUser.name){
    alert("You cannot send request for your own donation!");
    return;
  }
  selectedItem = item;
  document.getElementById('popupTitle').innerText = item.name + " (" + (item.type==='plant'?'Plant':'Seeds') + ")";
  document.getElementById('popupImg').src = item.image;
  document.getElementById('popupDesc').innerText = item.desc || '';
  document.getElementById('popupMsg').value = '';
  document.getElementById('plantPopup').style.display = 'flex';
}
function closePopup(){
  selectedItem = null;
  document.getElementById('plantPopup').style.display = 'none';
}

/* ===== SEND REQUEST =====
   When a requester sends a request, also save requester's contact & location (so donor can view it) */
function sendRequest(){
  if(!selectedItem) return;

  const requesterAddress = currentUser.location || buildAddressFromProfile(currentUser) || '';
  const requesterPhone = currentUser.phone || '';
  const donorAddress = selectedItem.address || selectedItem.location || selectedItem.donorLocation || '';
  const donorPhone = selectedItem.phone || '';

  // optional locality exact match - keep as before but compare full address if present
  if(requesterAddress && donorAddress){
    // normalize minimal whitespace and lower-case for comparison
    if(requesterAddress.trim().toLowerCase() !== donorAddress.trim().toLowerCase()){
      if(!confirm("Your full address is different from donor address. Do you still want to send request?")) {
        return;
      }
    }
  }

  const msg = document.getElementById('popupMsg').value || '';
  const newReq = {
    itemName: selectedItem.name,
    itemType: selectedItem.type,
    donor: selectedItem.donor,
    donorEmail: selectedItem.donorEmail || '',
    donorPhone: donorPhone,
    donorLocation: donorAddress,
    requester: currentUser.name,
    requesterEmail: currentUser.email || '',
    requesterPhone: requesterPhone,
    requesterLocation: requesterAddress,
    message: msg,
    date: new Date().toISOString(),
    status: "open"
  };

  requests.push(newReq);
  localStorage.setItem("requests", JSON.stringify(requests));
  alert("Request sent to donor!");
  closePopup();
}

/* ===== RENDER REQUESTS (for donors) ===== */
function renderRequests() {
  const list = document.getElementById('requestsList');
  list.innerHTML = '';
  const myItems = [...plants, ...seeds].filter(item => item.donor === currentUser.name);
  // requests that target my items and are open
  const myRequests = requests.filter(r => 
    myItems.some(item => item.name === r.itemName && item.donor === r.donor) && r.status === 'open'
  );

  if(myRequests.length === 0) {
    list.innerHTML = '<p class="muted">No requests yet.</p>';
    return;
  }

  myRequests.forEach(r => {
    const div = document.createElement('div');
    div.className = 'request-card';
    div.innerHTML = `
      <b>${r.requester}</b> requested your ${r.itemName} (${r.itemType})<br/>
      Message: ${r.message}<br/>
      <div style="margin-top:6px">
        <strong>Requester Contact:</strong><br/>
        üìß ${r.requesterEmail || 'Not provided'}<br/>
        üìû ${r.requesterPhone || 'Not provided'}<br/>
        üè† ${r.requesterLocation || 'Not provided'}
      </div>
      <span class="muted">${new Date(r.date).toLocaleString()}</span>
      <div style="margin-top:8px">
        <button class="small-btn" onclick="acceptRequest('${r.itemName}','${r.requester}')">Accept</button>
        <button class="small-btn ghost" onclick="rejectRequest('${r.itemName}','${r.requester}')">Reject</button>
      </div>
    `;
    list.appendChild(div);
  });
}

/* ===== ACCEPT REQUEST ===== */
function acceptRequest(itemName, requester) {
  const req = requests.find(r => r.itemName === itemName && r.requester === requester && r.donor === currentUser.name);
  if(req) {
    req.status = 'closed';
    // remove donated item from lists
    plants = plants.filter(p => !(p.name === itemName && p.donor === currentUser.name));
    seeds = seeds.filter(s => !(s.name === itemName && s.donor === currentUser.name));
    localStorage.setItem("plants", JSON.stringify(plants));
    localStorage.setItem("seeds", JSON.stringify(seeds));
    localStorage.setItem("requests", JSON.stringify(requests));
    alert("Request accepted. The item is removed from home and the user will be notified.");
    renderRequests();
    renderHome();
  }
}

/* ===== REJECT REQUEST ===== */
function rejectRequest(itemName, requester) {
  const req = requests.find(r => r.itemName === itemName && r.requester === requester && r.donor === currentUser.name);
  if(req) {
    req.status = 'rejected';
    localStorage.setItem("requests", JSON.stringify(requests));
    renderRequests();
  }
}

/* ===== MY ACCEPTED REQUESTS (for receivers) showing donor full contact/address ===== */
function renderMyRequests() {
  const list = document.getElementById('myRequestsList');
  list.innerHTML = '';
  const accepted = requests.filter(r => r.requester === currentUser.name && r.status === 'closed');
  if(accepted.length === 0) {
    list.innerHTML = '<p class="muted">No accepted requests yet.</p>';
    return;
  }
  accepted.forEach(r => {
    // prefer stored donorLocation / donorPhone inside request (works even after item removal)
    const donorAddress = r.donorLocation || r.address || 'Address not available';
    const donorPhone = r.donorPhone || r.phone || 'Phone not available';
    const donorEmail = r.donorEmail || 'Email not available';
    const div = document.createElement('div');
    div.className = 'request-card';
    div.innerHTML = `
      <b>${r.donor}</b> accepted your request for <b>${r.itemName}</b> (${r.itemType})<br/>
      Message: ${r.message}<br/>
      <div style="margin-top:6px">
        <strong>Donor Contact:</strong><br/>
        üìß ${donorEmail}<br/>
        üìû ${donorPhone}<br/>
        üè† ${donorAddress}
      </div>
      <span class="muted">${new Date(r.date).toLocaleString()}</span>
    `;
    list.appendChild(div);
  });
}

/* ===== RENDER PROFILE DONATIONS ===== */
function renderMyDonations() {
  const grid = document.getElementById('myDonations');
  grid.innerHTML = '';
  const myPlants = plants.filter(p => p.donor === currentUser.name);
  const mySeeds = seeds.filter(s => s.donor === currentUser.name);
  [...myPlants,...mySeeds].forEach(item => {
    const card = document.createElement('div');
    card.className = 'card';
    const typeLabel = item.type === 'plant' ? 'Plant' : 'Seeds';
    card.innerHTML = `<img src="${item.image}" /><b>${item.name}</b><div class="muted">${typeLabel}</div>
      <button class="small-btn ghost" onclick="editDonation('${item.name}','${item.type}')">Edit</button>
      <button class="small-btn" onclick="deleteDonation('${item.name}','${item.type}')">Delete</button>`;
    grid.appendChild(card);
  });
}

/* ===== EDIT & DELETE DONATION ===== */
function editDonation(name,type){
  let item = (type==='plant'?plants:seeds).find(i => i.name===name && i.donor===currentUser.name);
  if(item){
    if(type==='plant'){
      document.getElementById('plantName').value = item.name;
      // hidden field kept for compatibility but will be overwritten on save
      document.getElementById('plantLocation').value = item.address || item.location || '';
      document.getElementById('plantDescription').value = item.desc || '';
      showSection('donate');
      plants = plants.filter(p => p !== item);
    } else {
      document.getElementById('seedName').value = item.name;
      document.getElementById('seedQuantity').value = item.qty || '';
      document.getElementById('seedLocation').value = item.address || item.location || '';
      document.getElementById('seedDescription').value = item.desc || '';
      showSection('donateSeeds');
      seeds = seeds.filter(s => s !== item);
    }
    localStorage.setItem("plants", JSON.stringify(plants));
    localStorage.setItem("seeds", JSON.stringify(seeds));
  }
}

function deleteDonation(name,type){
  if(confirm("Are you sure to delete this donation?")){
    if(type==='plant'){
      plants = plants.filter(p => !(p.name===name && p.donor===currentUser.name));
      localStorage.setItem("plants", JSON.stringify(plants));
    } else {
      seeds = seeds.filter(s => !(s.name===name && s.donor===currentUser.name));
      localStorage.setItem("seeds", JSON.stringify(seeds));
    }
    renderMyDonations();
    renderHome();
  }
}

/* ===== PROFILE SAVE =====
   Save profile fields and propagate address/phone to user's existing donations */
function saveProfile(){
  const name = document.getElementById('profileNameInput').value.trim();
  const email = document.getElementById('profileEmailInput').value.trim();
  const door = document.getElementById('profileDoorInput').value.trim();
  const street = document.getElementById('profileStreetInput').value.trim();
  const city = document.getElementById('profileCityInput').value.trim();
  const state = document.getElementById('profileStateInput').value.trim();
  const pincode = document.getElementById('profilePincodeInput').value.trim();
  const phone = document.getElementById('profilePhoneInput').value.trim();
  const picInput = document.getElementById('profilePicInput');

  if(!name || !email || !city) return alert("Name, email and city are required!");

  // build full address string
  const parts = [];
  if(door) parts.push(door);
  if(street) parts.push(street);
  if(city) parts.push(city);
  if(state) parts.push(state);
  let fullAddress = parts.join(', ');
  if(pincode) fullAddress = fullAddress ? fullAddress + ' - ' + pincode : pincode;

  // previous name to find and update donations if the user changed their display name
  const prevName = currentUser.name || name;

  // update currentUser object
  currentUser.name = name;
  currentUser.email = email;
  currentUser.door = door;
  currentUser.street = street;
  currentUser.city = city;
  currentUser.state = state;
  currentUser.pincode = pincode;
  currentUser.phone = phone;
  currentUser.location = fullAddress;
  // profilePic handled below if provided

  // update profile picture if provided
  if(picInput.files && picInput.files[0]){
    const reader = new FileReader();
    reader.onload = function(e){
      currentUser.profilePic = e.target.result;
      document.getElementById('profileEditPic').src = e.target.result;
      document.getElementById('profilePic').src = e.target.result;
      localStorage.setItem('currentUser', JSON.stringify(currentUser));
    };
    reader.readAsDataURL(picInput.files[0]);
  } else {
    localStorage.setItem('currentUser', JSON.stringify(currentUser));
  }

  // update all user's donations (plants + seeds) to include the new address/phone and updated donor name/email if needed
  plants.forEach(p => {
    if(p.donor === prevName){
      p.donor = name;
      p.donorEmail = email;
      p.address = fullAddress;
      p.phone = phone;
    }
  });
  seeds.forEach(s => {
    if(s.donor === prevName){
      s.donor = name;
      s.donorEmail = email;
      s.address = fullAddress;
      s.phone = phone;
    }
  });

  localStorage.setItem("plants", JSON.stringify(plants));
  localStorage.setItem("seeds", JSON.stringify(seeds));

  document.getElementById('profileLabel').innerText = currentUser.name;
  document.getElementById('profileEmail').innerText = currentUser.email;
  alert("Profile updated successfully!");
}

/* ===== CARE TIPS ===== */
function addTip(){
  const val = document.getElementById('tipInput').value;
  if(!val) return;
  tips.push({text: val, author: currentUser.name, date: new Date().toISOString()});
  localStorage.setItem("tips", JSON.stringify(tips));
  document.getElementById('tipInput').value='';
  renderCareTips();
}
function renderCareTips(){
  const div = document.getElementById('careTips');
  div.innerHTML='';
  tips.forEach(t=>{
    const p = document.createElement('div');
    p.className='comment-box';
    p.innerHTML = `<span class="comment-author">${t.author}</span>: ${t.text}<br/><span class="muted">${new Date(t.date).toLocaleString()}</span>`;
    div.appendChild(p);
  });
}

/* INITIAL RENDER */
showSection('home');
</script>
</body>
</html>
